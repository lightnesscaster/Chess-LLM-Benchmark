{% extends "base.html" %}

{% block title %}Leaderboard - LLM Chess Benchmark{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-nav">
        <h1 class="active">Leaderboard</h1>
        <a href="/games" class="page-nav-link">Games</a>
        <a href="/methodology" class="page-nav-link">Methodology</a>
    </div>
    <p class="subtitle">LLMs ranked by Lichess Classical rating, estimated from real results using Glicko-2 and engine anchors</p>
</div>

{% if leaderboard %}
<div class="leaderboard-container">
    <table class="leaderboard-table">
        <thead>
            <tr>
                <th class="rank">#</th>
                <th class="player">Player</th>
                <th class="rating sortable sorted" data-sort="rating" data-dir="desc">Rating <span class="sort-arrow">â–¼</span></th>
                <th class="fide">FIDE Est.</th>
                <th class="rd">RD</th>
                <th class="ci">95% CI</th>
                <th class="games">Games</th>
                <th class="record">W-L-D</th>
                <th class="legal sortable" data-sort="legal" data-dir="desc">Legal% <span class="sort-arrow"></span></th>
                <th class="cost sortable" data-sort="cost" data-dir="desc">$/Game <span class="sort-arrow"></span></th>
            </tr>
        </thead>
        <tbody>
            {% set ns = namespace(top_llm_found=false) %}
            {% for entry in leaderboard %}
            {% set is_top_llm = not entry.is_anchor and not ns.top_llm_found %}
            {% if is_top_llm %}{% set ns.top_llm_found = true %}{% endif %}
            <tr class="{% if entry.is_anchor %}anchor{% elif is_top_llm %}top-llm{% endif %}{% if not entry.is_anchor and entry.rating_deviation > 80 %} unreliable{% endif %} clickable-row"
                data-player-id="{{ entry.player_id|e }}"
                data-rating="{{ entry.rating }}"
                data-legal="{{ entry.legal_move_rate|default(1.0) }}"
                data-cost="{{ entry.get('avg_cost_per_game') if entry.get('avg_cost_per_game') is not none else -1 }}">
                <td class="rank">{{ entry.rank }}</td>
                <td class="player">
                    {{ entry.player_id }}
                    {% if entry.is_anchor %}<span class="anchor-badge" title="Anchor (fixed rating)">*</span>{% endif %}
                    {% if is_top_llm %}<span class="crown-badge" title="Top-rated LLM">ðŸ‘‘</span>{% endif %}
                </td>
                <td class="rating">{{ entry.rating }}</td>
                <td class="fide">{% if entry.fide_estimate is not none %}~{{ entry.fide_estimate }}{% else %}N/A{% endif %}</td>
                <td class="rd">{% if entry.is_anchor %}N/A{% else %}{{ entry.rating_deviation }}{% endif %}</td>
                <td class="ci">{% if entry.is_anchor %}N/A{% else %}{{ entry.confidence_low }} - {{ entry.confidence_high }}{% endif %}</td>
                <td class="games">{{ entry.games_played }}</td>
                <td class="record">{{ entry.wins|default(0) }}-{{ entry.losses|default(0) }}-{{ entry.draws|default(0) }}</td>
                <td class="legal">{{ "%.1f"|format((entry.legal_move_rate|default(1.0)) * 100) }}%</td>
                <td class="cost">{% if entry.get('avg_cost_per_game') is not none %}${{ "%.4f"|format(entry.avg_cost_per_game) }}{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="legend">
    <p>ðŸ‘‘ = Top-rated LLM</p>
    <p><strong style="color: var(--accent)">*</strong> = Anchor player (fixed rating, used for calibration)</p>
    <p><span class="unreliable-indicator">Greyed rows</span> = Rating unreliable (RD > 80, needs more games)</p>
    <p><strong>FIDE Est.</strong> = Estimated FIDE rating based on <a href="https://chessgoals.com/rating-comparison/" target="_blank">ChessGoals.com</a> survey data</p>
    <p><strong>RD</strong> = Rating Deviation (uncertainty in rating)</p>
    <p><strong>95% CI</strong> = 95% Confidence Interval</p>
    <p><strong>Legal%</strong> = Percentage of moves that were legal on first attempt</p>
    <p><strong>$/Game</strong> = Average cost per game based on OpenRouter pricing</p>
</div>
{% else %}
<div class="empty-state">
    <p>No players in the leaderboard yet. Run some benchmark games to populate ratings.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Row click to view player games
    const rows = document.querySelectorAll('.clickable-row');
    rows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't navigate if clicking on a link
            if (e.target.tagName === 'A') return;
            const playerId = this.dataset.playerId;
            window.location.href = '/games?model=' + encodeURIComponent(playerId);
        });
    });

    // Sortable columns
    const table = document.querySelector('.leaderboard-table');
    if (!table) return;

    const tbody = table.querySelector('tbody');
    const headers = table.querySelectorAll('th.sortable');
    let currentSort = 'rating';
    let currentDir = 'desc';

    function sortTable(sortKey, direction) {
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            let aVal = parseFloat(a.dataset[sortKey]);
            let bVal = parseFloat(b.dataset[sortKey]);

            // Handle NaN values (malformed data)
            if (isNaN(aVal) && isNaN(bVal)) return 0;
            if (isNaN(aVal)) return 1;
            if (isNaN(bVal)) return -1;

            // Handle missing cost values (-1 means no cost data)
            if (sortKey === 'cost') {
                if (aVal === -1 && bVal === -1) return 0;
                if (aVal === -1) return 1;  // No cost goes last
                if (bVal === -1) return -1;
            }

            if (direction === 'desc') {
                return bVal - aVal;
            } else {
                return aVal - bVal;
            }
        });

        // Re-append rows in sorted order
        rows.forEach((row, index) => {
            row.querySelector('.rank').textContent = index + 1;
            tbody.appendChild(row);
        });

        // Update header indicators
        headers.forEach(h => {
            h.classList.remove('sorted');
            h.querySelector('.sort-arrow').textContent = '';
        });

        const activeHeader = table.querySelector(`th[data-sort="${sortKey}"]`);
        activeHeader.classList.add('sorted');
        activeHeader.querySelector('.sort-arrow').textContent = direction === 'desc' ? 'â–¼' : 'â–²';

        currentSort = sortKey;
        currentDir = direction;
    }

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const sortKey = this.dataset.sort;
            let newDir = 'desc';  // Default to descending

            // If clicking same column, toggle direction
            if (sortKey === currentSort) {
                newDir = currentDir === 'desc' ? 'asc' : 'desc';
            }

            sortTable(sortKey, newDir);
        });
    });
});
</script>
{% endblock %}
